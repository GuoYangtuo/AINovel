from openai import OpenAI
import json

class AI:
    def __init__(self, api_key):
        self.api_key = api_key
        self.client = OpenAI(api_key=api_key, base_url="https://api.deepseek.com")

    
    def call(self, role, prompt):
        return self.client.chat.completions.create(
            model="deepseek-chat",
            messages=[
                {"role": "system", "content": role},
                {"role": "user", "content": prompt},
            ],
            stream=False
        )

class 人物:
    def __init__(self, 基本信息, 性格, 背景故事, 人际关系):
        self.基本信息 = 基本信息
        self.性格 = 性格
        self.经历过的故事 = []
        for 故事 in 背景故事:   
            self.经历过的故事.append(故事)
        self.人物关系 = []
        for 关系 in 人际关系:
            self.人物关系.append(关系)
class 人物关系:
    def __init__(self, 人物1, 人物2, 关系):
        self.人物1 = 人物1
        self.人物2 = 人物2
        self.关系 = 关系

class 小说内容设定:
    def __init__(self, 世界观, 人物s):
        self.世界观 = 世界观
        self.人物s = 人物s

class 小说生成器:
    def __init__(self, 内容, 规则=""):
        self.内容 = 内容
        self.规则 = 规则
        self.ai = AI(api_key="sk-48d5645fd30347fe905e51c2d431113f")

        self.初始故事 = self.生成初始故事()
        print("@@@初始回答：",self.初始故事)
        self.处理回答(self.初始故事)

        下一段故事 = self.继续故事()
        print("@@@下一段故事：",下一段故事)
        self.处理回答(下一段故事)
    
    def 生成初始故事(self):
        role = """你是一个高水平小说作家"""
        prompt = "请根据以下信息写一个小说的开头，直到小叶遇到了人生轨迹转折点，面临关键抉择时停下，并给出几个可能的选项供我选择，以主人公的第一视角叙事，\n"
        if self.规则:
            prompt += f"{self.规则}\n"
        prompt += f"人物：{self.内容.人物s}\n"
        prompt += "我会给出选择并让你续写。主人公的选择会严重影响他的人生轨迹和整个故事的发展，甚至整个故事的结局和世界的走向都会因为主人公选择的不同而改变，保持一定的叙事节奏，不要提前透露所有世界观设定和人物信息，而是随着故事发展才逐渐揭露信息，选择不同，揭露信息的顺序和程度也不同，故事的发展方向也不同，给出选项即可，无需给出每个选项可能的后续发展\n你的输出格式：\n小说正文\n[\"选项1\",\"选项2\",...]\n不要输出格式外的任何无关内容"
        print("@@@初始prompt：",prompt)
        return self.ai.call(role, prompt).choices[0].message.content

    def 处理回答(self, 回答):
        print("@@@处理回答：")
        print(回答.split("[")[0])
        选项 = json.loads('['+回答.split("[")[1])
        self.上一次的抉择 = 选项[0]
        for a in 选项:
            print(a)
        print("@@@处理回答结束")

    def 继续故事(self):
        role = f"""
        你是一个高水平小说作家家
        """
        prompt = f"请根据主人公上一次的抉择，续写小说，直到主人公面临新的抉择时停下。\n一些信息:\n"
        if self.规则:
            prompt += f"{self.规则}\n"
        prompt += f"人物：{self.内容.人物s}\n"
        prompt += f"世界观：暂无\n"
        prompt += f"之前的故事：{self.初始故事}\n"
        prompt += f"上一次的抉择：{self.上一次的抉择}\n"
        prompt += f"""
        主人公的选择会严重影响他的人生轨迹和整个故事的发展，甚至整个故事的结局和世界的走向都会因为主人公选择的不同而改变，保持一定的叙事节奏，不要提前透露所有世界观设定和人物信息，而是随着故事发展才逐渐揭露信息，选择不同，揭露信息的顺序和程度也不同，故事的发展方向也不同，给出选项即可，无需给出每个选项可能的后续发展\n你的输出格式：\n小说正文\n[\"选项1\",\"选项2\",...]\n不要输出格式外的任何无关内容\n
        """
        print("@@@下一段prompt：",prompt)
        return self.ai.call(role, prompt).choices[0].message.content

人物s = [
    {
        "基本信息":"主人公小叶，一个现代都市的高中生，宅男，比较瘦弱，因为意外，唯一的亲人只剩母亲",
        "性格":"内向，喜欢独处，不善言辞",
        "背景故事":[
           "看起来有点高冷，但有时也会内心戏很多",
           "过去的十几年过着两点一线的普通高中生活，看起来和别人没什么不一样，在班里没什么存在感",
           "但有一天睡醒突然莫名其妙觉醒了读心术，能听到别人心里在想什么，他一直隐藏着这个能力，但也因此更对世间冷暖看淡，对人际关系不再抱有期待，看起来更加冷漠孤僻了",
             ],
        "人际关系":[]
    },{
        "基本信息":"小叶的母亲",
        "性格":"很年轻有活力，又有些幽默和乐观，看起来有点天然",
        "背景故事":[
            "过着一个普通的都市家庭主妇的生活"
        ],
        "人际关系":[]
    },{
        "基本信息":"小叶的同桌小七",
        "性格":"活泼开朗，成绩优异，在班级里很受欢迎",
        "背景故事":[
            "对所有人都很友好",
            "注意到小叶的与众不同，对他产生了好奇",
            "经常主动找小叶说话，但总是得不到太多回应"
        ],
        "人际关系":[]
    },{
        "基本信息":"神秘的超能力组织的头目",
        "性格":"神出鬼没，有点喜欢玩弄人心",
        "背景故事":[
            "暗中观察着所有超能力者的动向",
            "拥有强大的精神控制能力",
            "表面上经营着一家心理咨询诊所作为掩护"
        ],
        "人际关系":[
            "与多个超能力者保持联系，但从不透露自己的身份",
            "对小叶的能力特别关注，但还未主动接触"
        ]
    },{
        "基本信息":"小叶的班主任大刘",
        "性格":"严肃认真，对学生要求严格",
        "背景故事":[
            "对小叶的冷漠态度感到困惑"
        ],
        "人际关系":[]
    },{
        "基本信息":"小叶的同桌的朋友小晴",
        "性格":"活泼开朗，成绩优异，在班级里很受欢迎",
        "背景故事":[
            "对所有人都很友好",
            "同样也是超能力者，但和小叶并不相识",
            "从属于神秘的超能力组织，经常消失一段时间去完成特殊任务"
        ],
        "人际关系":[]
    }
]


小说内容 = 小说内容设定(世界观="一个现代都市",人物s=人物s)
小说生成器实例 = 小说生成器(小说内容)